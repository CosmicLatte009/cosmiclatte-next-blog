---
title: '[CS] 브라우저 렌더링과 DOM'
date: '2023-03-10'
tags: ['CS', '브라우저 렌더링', 'DOM']
draft: false
summary: '파싱, DOM트리, CSSOM트리, 스타일 계산, 레이아웃 계산, 페인트, 컴포지팅'
---

# 브라우저 렌더링 과정

파싱, 스타일 계산, 레이아웃, 페인트, 컴포지팅 다섯 단계로 이루어져 있다.

각 단계는 반드시 전 단계의 데이터가 필요하다.

html의 레이아웃이 변경되면 레이아웃 단계에서 렌더 트리가 재생성된다. (리플로우)  
레이아웃과 관련 없는 스타일이 변경되면 페인트 단계가 재실행된다. (리페인트)

<div align="center">
  ![image](https://user-images.githubusercontent.com/87015026/223955642-89b08dc5-d710-4b95-9c31-09f840279cfc.png)
</div>

## 0. 파일을 서버에 요청

파싱 단계에서 필요한 HTML 데이터는 서버에서 받아와야한다.  
클라이언트에서 불러오고 싶은 파일을 서버에 요청하는 것이다.

1. 주소창에 주소 입력 혹은 클릭을 통해 웹페이지 접근
2. 클라이언트에서 요청한 URI를 DNS(Domain Name System)를 통해 IP 주소로 변환
3. 해당 IP를 가진 서버에 GET 요청 보내기

## 1. 파싱

서버에서 응답으로 받은 HTML 데이터를 파싱한다.

1. 브라우저는 서버로부터 HTML 데이터를 **바이트(2진수)** 형태로 응답 받는다.
2. `<meta>` 태그의 charset 속성에 의해 지정된 인코딩 방식을 기준으로 바이트 형태의 HTML을 문자열로 변환한다.
3. 문자열로 변환된 HTML을 읽어 들여 문법적 의미를 갖는 코드의 최소 단위인 토큰(token)들로 분해한다.
4. 각 token들을 객체(DOM)으로 변환하여 노드들(DOME 트리)을 생성한다.

   토큰의 내용에 따라 '문서 노드', '요소 노드', '어트리뷰트(속성) 노드', '텍스트 노드'를 생성한다.

<div align="center">
  ![image](https://user-images.githubusercontent.com/87015026/223961397-5343ca0a-b952-418b-b838-c8c7e64b2a09.png)
</div>

## 2. 스타일 계산

CSS 마크업을 바탕으로 CSSOM 트리를 생성한다.
DOM 트리처럼 바이트 -> 문자열 -> 토큰 -> 노드 -> CSSOM 순을 거쳐서 생성한다.

## 3. 레이아웃 계산

DOM 트리와 CSSOM 트리를 결합하여 렌더 트리를 형성하고,  
이 렌더 트리를 기반으로 HTML 요소의 위치와 크기, 즉 레이아웃을 계산한다.

- **리플로우**

  html의 레이아웃이 변경되면 레이아웃 계산 단계가 재실행되어 렌더 트리가 재생성된다.

## 4. 페인트

레이아웃을 바탕으로 브라우저 화면에 픽셀을 렌더링하는 페인팅 처리를 해준다.

- **리페인트**

  레이아웃과 관련 없는 스타일이 변경되면 페인트 계산 단계가 재실행된다.

## 5. 컴포지팅

페인팅 과정에서 각각 그려진 레이어들을 하나의 비트맵으로 합성해서 페이지를 완성한다.

---

# DOM (Document Object Model)

DOM은 웹 페이지에 나타나는 HTML 문서 전체를 노드 객체로 표현한 것이다.  
HTML에 부모자식 계층 있듯이 DOM 역시 **document 객체**를 최상위로 둔 계층 구조 (DOM 트리)를 이룬다.

document 객체 내 프로퍼티와 메서드로 새 컨텐츠 생성이 가능하고  
웹 페이지 내부에 무엇이든 수정도 가능하다.

<div align="center">
  ![image](https://user-images.githubusercontent.com/87015026/224095809-5afb7fe1-6893-4131-b7f5-5afd052a12eb.png)
</div>

---

# 브라우저 렌더링 과정에서 JavaScript 동작 방식

`<script>` 태그를 만나면 JavaScript 코드를 파싱하기 위해  
브라우저 렌더링 엔진이 DOM 생성을 일시 중단하고 JavaScript 엔진에 제어권을 넘긴다.

JavaScript 엔진은 JavaScript 코드를 파싱하여  
CPU가 이해할 수 있는 **저수준 언어로 변환하고 실행**하는 역할을 한다.

먼저 JavaScript 코드를 해석하여 추상적 구문 트리(AST)를 생성하고,  
이 트리를 기반으로 인터프리터에서 실행이 가능한 중간코드인 **바이트 코드를 생성하여 실행**한다.

- ### script 태그를 body 태그 내 밑에 두는 이유

HTML 파서는 `<script>` 태그를 만나면 파싱을 멈추고 스크립트 파일을 읽기 때문에 HTML 코드 중간에 `<script>` 태그가 있으면 무거운 JavaScript 코드를 불러오고 실행하느라 DOM 생성이 지연된다.  
DOM 생성이 지연되면 브라우저 렌더링에 방해가 되므로 미완성 화면이 오래 유지될 수 있다.

따라서 `<script>` 태그는 HTML 코드를 모두 작성 후 `<body>` 태그 닫기 직전에 작성하는 것이 좋다.
